<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<style type="text/css">
A.black:link {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:visited {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:hover {COLOR: #FFFFFF; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
.b {text-decoration: none; color:#FF0000;} 
.b:hover {color:#7785FF;}
.c {text-decoration: none; color:#000000;} 
.c:hover {color:#FFFFFF;}
 pre {color: blue;}
TD.colon {COLOR: #000000; FONT-FAMILY: "MS Sans Serif", sans-serif; FONT-SIZE: 9pt}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta content="программирование на Visual Basic, документация, документы, delphi, pascal, cpp, hardware, web, веб-мастер, советы, описания, доки, manual, Java, C, C++, обучение, исходники, odbc, jdbc, programm, protocols, протоколы, общение, форумapplet, java, design, апплет, дизайн, ява, Free, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources" name="keywords">
<meta NAME="RESOURCE-TYPE"
CONTENT="pop hypertext sources hypermedia server scripting shtml phtml html developer code base tools open source web site browser free software webmaster cgi dhtml dynamic content netscape explorer shareware download website construction free tutorial news design maintenance page hit cvs mailing list projects httpd mod_perl mod www htdig xml perl scripts script server-side-include apache database MySQL mysql msql postres postresql module linux online cpp Visual Basic JavaScript delphi wap job informer java opengl directx">
<title>Информационный сервер для программистов - исходники со всего света.</title>
</head>

<body topmargin="0" leftmargin="0" marginwidth="0" marginheigth="0" bgcolor=white>

<form action="/cgi-bin/sources/search/search.pl" method="get" align="left">
  <input type="hidden" name="stpos" value="0"><table border="0" cellpadding="0"
  cellspacing="0" width="750">
    <tr>
      <td valign="top" rowspan="2"><table border="0" cellpadding="0" cellspacing="0" width="287">
        <tr>
          <td colspan="2" bgcolor="#A5E4A7" valign="middle" align="center"><b>WWW.ИСХОДНИКИ.РУ</b></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">cpp.sources.ru</font></b></td>
        </tr>
        <tr>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">java.sources.ru</font></b></td>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>web.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>soft.sources.ru</b></font></td>
        </tr>
        <tr>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>jdbc.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>asp.sources.ru</b></font></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">api.sources.ru</font></b></td>
        </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td><font style="font-size: 8pt" size="2" face="Tahoma">&nbsp; Поиск по
          программированию :<br>
          </font>&nbsp; <input type="text" size="13" name="query"> <input type="submit"
          value="Поиск"><font size="1"><input
          TYPE="Radio" NAME="stype" VALUE="AND" checked>&quot;AND&quot; <input TYPE="Radio"
          NAME="stype" VALUE="OR">&quot;OR&quot;</font>


<!--TopList COUNTER--><a target=_top
href="http://top.list.ru/jump?from=89876"><script language="JavaScript"><!--
d=document;a='';a+=';r='+escape(d.referrer)
js=10//--></script><script language="JavaScript1.1"><!--
a+=';j='+navigator.javaEnabled()
js=11//--></script><script language="JavaScript1.2"><!--
s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
js=12//--></script><script language="JavaScript1.3"><!--
js=13//--></script><script language="JavaScript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=89876;t=57;js='+js+a+';rand='+Math.random()+
'" alt="TopList" '+ 'border=0 height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=89876;t=57"
border=0 height=1 width=1
alt="TopList"></noscript><script language="JavaScript"><!--
if(js>11)d.write('--'+'>')//--></script></a><!--TopList COUNTER-->


<a href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?163871" alt="Rambler's Top100" width=1 height=1 border=0></a>

<!-- SpyLOG f:0211 --> 
<script language="javascript"> 
u="u1624.10.spylog.com";d=document;nv=navigator;na=nv.appName;p=1; 
bv=Math.round(parseFloat(nv.appVersion)*100); 
n=(na.substring(0,2)=="Mi")?0:1;rn=Math.random();z="p="+p+"&rn="+rn;y=""; 
y+="<a href='http://"+u+"/cnt?f=3&p="+p+"&rn="+rn+"' target=_blank>"; 
y+="<img src='http://"+u+"/cnt?"+z+ "&r="+escape(d.referrer)+"&pg="+escape(window.location.href)+"' border=0 width=1 height=1 alt='SpyLOG'>"; 
y+="</a>"; d.write(y);if(!n) { d.write("<"+"!--"); }//--></script><noscript> 
<a href="http://u1624.10.spylog.com/cnt?f=3&p=1" target=_blank> 
<img src="http://u1624.10.spylog.com/cnt?p=1" alt='SpyLOG' border='0' width=1 height=1 > 
</a></noscript><script language="javascript1.2"><!-- 
if(!n) { d.write("--"+">"); }//--></script> 
<!-- SpyLOG -->


</td>
        </tr>
      </table>
      </td>
      <td align="center"><font style="font-size: 15pt" color="#4904B1" size="4"
      face="Times New Roman">Информационный сервер</font></td>
    </tr>
    <tr>
      <td>


<!-- LBE -->
<script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://www.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://www.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE ismap></a><br>");
// -->
</script>
<noscript>
                                                                                                                                                                <br>
</noscript>
<!-- LBE -->



      </td>
    </tr>
    <tr>
      <td colspan="2"><table border="0" cellpadding="0" cellspacing="1" width="100%">
        <tr>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a
          href="../www.sources.html"><font color="#000000" size="2">На главную</font></a></td>
          <td align="center" width="20%" bgcolor="#E0E0C6"><a
          href="../subscribe.html"><font color="#000000" size="2">Подписаться на новости</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../cgi-bin/sources/Ultimate.pl"><font color="#000000" size="2">Форум</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../books.html"><font color="#000000" size="2">Книги</font></a></td>
          <td align="center" width="7%" bgcolor="#E0E0C6"><a href="http://chat.vidcenter.ru:82/"><font color="#000000" size="2">Чат</font></a></td>
          <td align="center" width="13%" bgcolor="#E0E0C6"><a href="http://www.countries.ru/"><font color="#000000" size="2">Страны мира</font></a></td>
          <td align="center" width="29%" bgcolor="#E0E0C6"><b>10</b> пользователей на сервере.
</td>
        </tr>
      </table>
      </td>
    </tr>
  </table>
</form>

<div align="center"><center>

<table width="680" cellspacing="0" cellpadding="0">
  <tr>
    <td><hr>
    <h3 align="center"><font color="#a0a099">Механизм обработки
    сетевых событий в Winsock2 </font></h3>
    <hr>
    <p>Автор: <b><a href="mailto:jdempsey@cox.rr.com">Joseph Dempsey</a> </b></p>
    <p>Обычно, при программировании сокетов под Winsock 1.1,
    используются стандартные и, надеюсь известные
    большинству программистов операторы. При этом
    оповещение о событии на сокете проходит через
    сообщения windows. Думаю, не секрет, что такой способ
    порождает массу проблем при разработке
    приложений. Однако можно воспользоваться другим
    методом - в обход сообщений Windows, а именно через
    события WSA (WSA Events).</p>
    <h3>Как это работает? </h3>
    <p>При работе с сокетом большинство программистов
    используют стандартный набор событий: для
    отправки данных, приёма данных, соединения с
    другим сокетом, для установления канала передачи
    данных при входящем запросе и для закрытия
    сокета. Возможно есть и другие события для
    сокетов, но в этой статье мы сосредоточимся на
    основных. Когда одно из этих событий,
    ассоциированных с сокетом, происходит, то мы
    получаем сигнал и производим необходимые
    действия для обработки данного события. </p>
    <p>Вот основные константы, описывающие сетевые
    события (те, которые будут фигурировать в данной
    статье): </p>
    <p><code>FD_ACCEPT <br>
    FD_READ <br>
    FD_WRITE <br>
    FD_CLOSE <br>
    FD_CONNECT<br>
    </code></p>
    <p>Итак, давайте рассмотрим весь процесс создания,
    отслеживания и обработки сетевых событий.</p>
    <p>Во-первых нам прийдётся инициализировать
    библиотеку winsock2. Впринципе существует
    нескольколько способов сделать это, например так:
    </p>
    <pre>WSADATA wsd;
LPFN_WSASTARTUP lpf = (LPFN_WSA_STARTUP)::GetProcAddress( ::LoadLibrary(<span
class="cpp-string">&quot;WS2_32.DLL&quot;</span>),
                                                             <span
class="cpp-string">&quot;WSAStartup&quot;</span>);
lpf(<span class="cpp-literal">0x0202</span>, &amp;wsd);
</pre>
    <p>Инициализировать можно в любом месте программы,
    но обязательно до вызова каких-либо функций winsock.
    Следующий важный момент - это создание события,
    которое мы хотим отслеживать на данном сокете.
    Для этого будем использовать вызов Winsock2 API&nbsp; <code>::WSACreateEvent();
    </code>После того, как событие создано, его нужно
    связать с сокетом, события которого мы хотим
    контролировать и обрабатывать. Это делается
    функцией <code>WSAEventSelect(...).&nbsp; </code>Следующий пример
    показывает, как отследить событие,
    сигнализирующее о том, что на сокет пришёл запрос
    на установление канала связи. Обычно такую
    операцию можно проделывать на прослушивающем (listening)
    сокете.&nbsp; В примере это <code>SOCKET m_listen </code>. Итак,
    как это выглядит::&nbsp; </p>
    <pre>WSAEVENT hEvent = WSA_INVALID_EVENT;
hEvent = WSACreateEvent();
::WSAEventSelect(m_listen, m_hEvent, FD_ACCEPT);		
</pre>
    <p>Если мы хотим, чтобы сокет (в данном случае это <code>SOCKET
    m_socket</code> ) информировал нас о том, что готов
    принять или передать данные, то событие
    создаётся следующим образом: </p>
    <pre>WSAEVENT hDataEvent = WSA_INVALID_EVENT;
hDataEvent = WSACreateEvent();
::WSAEventSelect(m_socket, hDataEvent, FD_WRITE | FD_READ | FD_CLOSE);
</pre>
    <p>Необходимо заметить, что для одного и того же
    сокета невозможно создать два объекта событий,
    то есть следующий код неверен:</p>
    <pre>WSAEVENT hEvent1 = WSA_INVALID_EVENT;
WSAEVENT hEvent2 = WSA_INVALID_EVENT;

hEvent1 = WSACreateEvent();
hEvent2 = WSACreateEvent();

::WSAEventSelect(m_socket, hEvent1, FD_READ);
::WSAEventSelect(m_socket, hEvent2, FD_WRITE);
</pre>
    <p>&nbsp; </p>
    <h2>Обработка уведомлений о событиях</h2>
    <p>Теперь, когда события заданы, нам необходимо
    ожидать их и, соответственно, обрабатывать. Для ожидания
    событий можно использовать функцию <code>WSAWaitForMultipleEvents(...).
    </code>Эта функция будет работать как поток в спящем
    режиме до тех пор, пока не произойдёт событие, на
    которое мы хотели бы отреагировать. Давайте
    посмотрим на пример вызова этой функции:</p>
    <pre>//<code> m_listen </code> и <code> m_data </code>два существующих сокета:
WSAEVENT hEvent1 = WSACreateEvent();
WSAEVENT hEvent2 = WSACreateEvent();

::WSAEventSelect(m_listen, hEvent1,  FD_ACCEPT);
::WSAEventSelect(m_data,   hEvent2,  FD_READ | FD_CLOSE);

WSAEVENT* pEvents = (WSAEVENT*)::calloc(2, WSAEVENT);
pEvents[0] = hEvent1;
pEvents[1] = hEvent2;

int nReturnCode = ::WSAWaitForMultipleEvents(2, pEvents, FALSE, INFINITE, FALSE);
</pre>
    <p>Если же мы хотим ожидать только одного события,
    то эту функцию можно вызвать следующим образом: </p>
    <pre> <span class="cpp-keyword">int</span> nReturnCode = ::WSAWaitForMultipleEvents(<span
class="cpp-literal">1</span>, &amp;hEvent1, FALSE, INFINITE, FALSE); </pre>
    <p>Первый параметр - это количество событий,
    которые мы хотим ожидать. Второй параметр - это
    указатель на массив событий, которые мы хотим
    ожидать. Третий параметр имеет значение BOOL,
    которое определяет - будет ли функция оставаться
    в спящем режиме до тех пор пока не сработают все
    события. Обычно этот параметр задаётся как false, но
    возможно Вам может понадобиться ожидать
    наступления всех событий. Четвёртый параметр
    определяет - как долго ожидать наступления
    события. Обычно я запускаю отдельный поток и
    оставляю его как infinite. Но, если Вы будете
    запускать функцию в основном потоке, то может
    понадобиться поставить ограничение в 5 (или
    больше) секунд, чтобы дать возможность
    приложению обрабатывать другие события. Пятый
    параметр указывает на то, хотим мы или нет
    получать алерты.</p>
    <p>Теперь необходимо позаботиться об
    обработчиках каждого события. Перво-наперво нам
    необходимо получить достоверную информацию о
    том, какое событие возникло. Для этого существует
    функция <code>::WSAEnumNetworkEvents(...).</code> Один из
    параметров которой - это структура под названием <code>WSANETWORKEVENTS</code>.
    Принимая во внимание код, приведённый выше,
    получим следующее: </p>
    <pre>WSANETWORKEVENTS hConnectEvent;
WSANETWORKEVENTS hProcessEvent;

::WSAEnumNetworkEvents(m_listen, hConnectEvent, &amp;wsaConnectEvents);
::WSAEnumNetworkEvents(m_data,   hProcessEvent, &amp;wsaProcessEvents);
</pre>
    <p>В заключении мы получаем событие, которое
    возникает на одном из сокетов. Давайте посмотрим,
    как выглядит процесс выборки нужного события и
    его обработки: </p>
    <pre><span class="cpp-keyword">if</span>( (wsaConnectEvents.lNetworkEvents &amp; FD_ACCEPT) &amp;&amp;	<span
class="cpp-comment">//Нужное ли нам событие</span> ?
   (wsaConnectEvents.iErrorCode[FD_ACCEPT_BIT] == <span
class="cpp-literal">0</span>) )	<span class="cpp-comment">//если нет ошибок,</span>
   {                                                    //<span
class="cpp-comment">то обрабатывае</span>м
	<span class="cpp-comment">/*
		....
		Здесь находится обработчик
		....
	*/</span>
   }
</pre>
    <p>Эта проверка может быть сделана для каждого
    WSAEVENT, который Вы установили, и для каждого
    сетевого события, для которого WSAEVENT будет
    сигнализировать. Для обработки другого события,
    в последнем примере достаточно изменить FD_ACCEPT на
    необходимую константу и, соотвественно изменить
    константу проверки бита ошибки.</p>
    <p><br>
    <br>
    </td>
  </tr>
</table>
</center></div>


<hr>
<div align="center"><center>

<table border="0" cellpadding="0" cellspacing="3" width="468">
  <tr>
    <td width="154"><!-- LBE_LITE --> <script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://lite.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://lite.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE_LITE ismap></a><br>");
// -->
</script> <noscript> <br>
</noscript><!-- LBE_LITE --></td>
  </tr>
</table>
</center></div>
</body>
</html>
