<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<style type="text/css">
A.black:link {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:visited {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:hover {COLOR: #FFFFFF; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
.b {text-decoration: none; color:#FF0000;} 
.b:hover {color:#7785FF;}
.c {text-decoration: none; color:#000000;} 
.c:hover {color:#FFFFFF;}
 pre {color: blue;}
TD.colon {COLOR: #000000; FONT-FAMILY: "MS Sans Serif", sans-serif; FONT-SIZE: 9pt}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta content="программирование на Visual Basic, документация, документы, delphi, pascal, cpp, hardware, web, веб-мастер, советы, описания, доки, manual, Java, C, C++, обучение, исходники, odbc, jdbc, programm, protocols, протоколы, общение, форумapplet, java, design, апплет, дизайн, ява, Free, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources" name="keywords">
<meta NAME="RESOURCE-TYPE"
CONTENT="pop hypertext sources hypermedia server scripting shtml phtml html developer code base tools open source web site browser free software webmaster cgi dhtml dynamic content netscape explorer shareware download website construction free tutorial news design maintenance page hit cvs mailing list projects httpd mod_perl mod www htdig xml perl scripts script server-side-include apache database MySQL mysql msql postres postresql module linux online cpp Visual Basic JavaScript delphi wap job informer java opengl directx">
<title>Информационный сервер для программистов - исходники со всего света.</title>
</head>

<body topmargin="0" leftmargin="0" marginwidth="0" marginheigth="0" bgcolor=white>

<form action="/cgi-bin/sources/search/search.pl" method="get" align="left">
  <input type="hidden" name="stpos" value="0"><table border="0" cellpadding="0"
  cellspacing="0" width="750">
    <tr>
      <td valign="top" rowspan="2"><table border="0" cellpadding="0" cellspacing="0" width="287">
        <tr>
          <td colspan="2" bgcolor="#A5E4A7" valign="middle" align="center"><b>WWW.ИСХОДНИКИ.РУ</b></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">cpp.sources.ru</font></b></td>
        </tr>
        <tr>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">java.sources.ru</font></b></td>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>web.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>soft.sources.ru</b></font></td>
        </tr>
        <tr>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>jdbc.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>asp.sources.ru</b></font></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">api.sources.ru</font></b></td>
        </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td><font style="font-size: 8pt" size="2" face="Tahoma">&nbsp; Поиск по
          программированию :<br>
          </font>&nbsp; <input type="text" size="13" name="query"> <input type="submit"
          value="Поиск"><font size="1"><input
          TYPE="Radio" NAME="stype" VALUE="AND" checked>&quot;AND&quot; <input TYPE="Radio"
          NAME="stype" VALUE="OR">&quot;OR&quot;</font>


<!--TopList COUNTER--><a target=_top
href="http://top.list.ru/jump?from=89876"><script language="JavaScript"><!--
d=document;a='';a+=';r='+escape(d.referrer)
js=10//--></script><script language="JavaScript1.1"><!--
a+=';j='+navigator.javaEnabled()
js=11//--></script><script language="JavaScript1.2"><!--
s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
js=12//--></script><script language="JavaScript1.3"><!--
js=13//--></script><script language="JavaScript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=89876;t=57;js='+js+a+';rand='+Math.random()+
'" alt="TopList" '+ 'border=0 height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=89876;t=57"
border=0 height=1 width=1
alt="TopList"></noscript><script language="JavaScript"><!--
if(js>11)d.write('--'+'>')//--></script></a><!--TopList COUNTER-->


<a href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?163871" alt="Rambler's Top100" width=1 height=1 border=0></a>

<!-- SpyLOG f:0211 --> 
<script language="javascript"> 
u="u1624.10.spylog.com";d=document;nv=navigator;na=nv.appName;p=1; 
bv=Math.round(parseFloat(nv.appVersion)*100); 
n=(na.substring(0,2)=="Mi")?0:1;rn=Math.random();z="p="+p+"&rn="+rn;y=""; 
y+="<a href='http://"+u+"/cnt?f=3&p="+p+"&rn="+rn+"' target=_blank>"; 
y+="<img src='http://"+u+"/cnt?"+z+ "&r="+escape(d.referrer)+"&pg="+escape(window.location.href)+"' border=0 width=1 height=1 alt='SpyLOG'>"; 
y+="</a>"; d.write(y);if(!n) { d.write("<"+"!--"); }//--></script><noscript> 
<a href="http://u1624.10.spylog.com/cnt?f=3&p=1" target=_blank> 
<img src="http://u1624.10.spylog.com/cnt?p=1" alt='SpyLOG' border='0' width=1 height=1 > 
</a></noscript><script language="javascript1.2"><!-- 
if(!n) { d.write("--"+">"); }//--></script> 
<!-- SpyLOG -->


</td>
        </tr>
      </table>
      </td>
      <td align="center"><font style="font-size: 15pt" color="#4904B1" size="4"
      face="Times New Roman">Информационный сервер</font></td>
    </tr>
    <tr>
      <td>


<!-- LBE -->
<script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://www.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://www.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE ismap></a><br>");
// -->
</script>
<noscript>
                                                                                                                                                                <br>
</noscript>
<!-- LBE -->



      </td>
    </tr>
    <tr>
      <td colspan="2"><table border="0" cellpadding="0" cellspacing="1" width="100%">
        <tr>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a
          href="../www.sources.html"><font color="#000000" size="2">На главную</font></a></td>
          <td align="center" width="20%" bgcolor="#E0E0C6"><a
          href="../subscribe.html"><font color="#000000" size="2">Подписаться на новости</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../cgi-bin/sources/Ultimate.pl"><font color="#000000" size="2">Форум</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../books.html"><font color="#000000" size="2">Книги</font></a></td>
          <td align="center" width="7%" bgcolor="#E0E0C6"><a href="http://chat.vidcenter.ru:82/"><font color="#000000" size="2">Чат</font></a></td>
          <td align="center" width="13%" bgcolor="#E0E0C6"><a href="http://www.countries.ru/"><font color="#000000" size="2">Страны мира</font></a></td>
          <td align="center" width="29%" bgcolor="#E0E0C6"><b>5</b> пользователей на сервере.
</td>
        </tr>
      </table>
      </td>
    </tr>
  </table>
</form>

<div align="center"><center>

<table width="680" cellspacing="0" cellpadding="0">
  <tr>
    <td><hr>
    <h3 align="center"><font color="#a0a099">Как получить список
    пользователей с сервера</font></h3>
    <hr>
    <p>Автор: <b><a href="mailto:derek_lakin@lineone.net">Derek Lakin</a></b><ul>
      <li><a href="NetInfo_src.zip">Скачать исходник - 9 Kb</a> </li>
      <li><a href="GetUserNames_demo.zip">Скачать демонстрационный
        проект - 20 Kb</a></li>
    </ul>
    <p><img height="400" src="GetUserNames.gif" width="654"></p>
    <h2>Описание</h2>
    <p>Пример показывает, как пользоваться функцией
    NetQueryDisplayInformation, для получения специфической
    информации о пользователях, а так же представлен
    класс, который позволяет получить более общий
    доступ к данному сервису.</p>
    <h2>Детальное описание функции</h2>
    <p>Прототип функции выглядит так:</p>
    <pre><b>NET_API_STATUS NetQueryDisplayInformation(</b>
<b>  LPCWSTR</b><i> ServerName</i><b>,</b>
<b>  DWORD</b><i> Level</i><b>,</b>
<b>  DWORD</b><i> Index</i><b>,</b>
<b>  DWORD</b><i> EntriesRequested</i><b>,</b>
<b>  DWORD</b><i> PreferredMaximumLength</i><b>,</b>
<b>  LPDWORD</b><i> ReturnedEntryCount</i><b>,</b>
<b>  PVOID</b><i> *SortedBuffer</i><b>);</b>
</pre>
    <p>Возвращаемый тип <code>NET_API_STATUS</code> определён как <code>DWORD</code>.
    Если функция завершается успешно, то
    возвращаемое значение будет <code>ERROR_SUCCESS</code>
    (соответствует Win32 коду 0). Так же возможны
    следующие значения ошибки:</p>
    <table>
<TBODY>
      <tr vAlign="top">
        <th align="left" width="30%">Значение</th>
        <th align="left" width="70%">Описание</th>
      </tr>
      <tr vAlign="top">
        <td width="30%">ERROR_ACCESS_DENIED</td>
        <td width="70%">Пользователь не имеет доступа к
        запрашиваемой информации.</td>
      </tr>
      <tr vAlign="top">
        <td width="30%">ERROR_INVALID_LEVEL</td>
        <td width="70%">Параметр <i>Level</i> имеет неправильное
        значение.</td>
      </tr>
      <tr vAlign="top">
        <td width="30%">ERROR_MORE_DATA </td>
        <td width="70%">Данная ошибка сигнализирует о том, что
        на сервере доступно больше ячеек информации. Это
        говорит о том, что параметр <i>SortedBuffer</i> содержит
        не последнюю доступную ячейку информации. Для
        получения дополнительных данных, необходимо
        вызвать <b>NetQueryDisplayInformation</b> заново с параметром <i>Index</i>
        , содержащем значение, возвращённое в <b>next_index</b>
        члене последней ячейки в <i>SortedBuffer</i>. </td>
      </tr>
</TBODY>
    </table>
    <p>Так же возможно возникновение ошибки со
    значением 1722, которая соответствует <code>RPC_S_SERVER_UNAVAILABLE</code>.
    Это говорит о том, что сервер в данный момент не
    доступен. Конечто не обязательно, но желательно
    включать в код программы проверку на
    возникновение данной ошибки.</p>
    <p>Первый параметр <code>ServerName</code> - это строка Unicode
    wide-character, которая нам нужна, чтобы использовать <code>MultiByteToWideChar</code>
    для преобразования стандартных строк в
    необходимый формат. Он может быть <code>NULL</code>. При
    этом функция вернёт информацию о локальном
    компьютере. Если же не <code>NULL</code>, то строка должна
    начинаться с \\.</p>
    <p>Особый интерес представляет параметр Level. Этот
    параметр указывает уровень получаемой
    информации, и может иметь одно из следующих
    значений. </p>
    <table>
<TBODY>
      <tr vAlign="top">
        <th align="left" width="13%">Значение</th>
        <th align="left" width="87%">Описание</th>
      </tr>
      <tr vAlign="top">
        <td width="13%">1</td>
        <td width="87%">Получить информацию о пользователях.
        Параметр <i>SortedBuffer</i> указывает на массив
        структуры <b>NET_DISPLAY_USER</b>.</td>
      </tr>
      <tr vAlign="top">
        <td width="13%">2</td>
        <td width="87%">Получить информацию о компьютере.
        Параметр <i>SortedBuffer</i> указывает на массив
        структуры <b>NET_DISPLAY_MACHINE</b>.</td>
      </tr>
      <tr vAlign="top">
        <td width="13%">3</td>
        <td width="87%">Получить информацию о группе. Параметр <i>SortedBuffer</i>
        указывает на массив структуры <b>NET_DISPLAY_GROUP</b>.</td>
      </tr>
</TBODY>
    </table>
    <p>Так как нас интересует информация о
    пользователях, то устанавливаем данный параметр
    в 1.</p>
    <p>Теперь давайте посмотрим, как выглядит
    структура<code> NET_DISPLAY_USER</code>:</p>
    <pre><b><span class="cpp-keyword">typedef</span> <span class="cpp-keyword">struct</span> _NET_DISPLAY_USER {</b>
<b>  LPWSTR</b><i>   usri1_name</i><b>;</b>
<b>  LPWSTR</b><i>   usri1_comment</i><b>;</b>
<b>  DWORD</b><i>    usri1_flags</i><b>;</b>
<b>  LPWSTR</b><i>   usri1_full_name</i><b>;</b>
<b>  DWORD</b><i>    usri1_user_id</i><b>;</b>
<b>  DWORD</b><i>    usri1_next_index</i><b>;</b>
<b>} NET_DISPLAY_USER, *PNET_DISPLAY_USER;</b>
</pre>
    <p>Не будем вдаваться в подробности описания
    каждого поля данной структуры. Так как нас
    интересует только список пользователей, то
    обратим внимание на два поля: <code>usri1_name</code>, в
    котором хранится логин пользователя и <code>usri1_full_name</code>,
    в котором содержится полное имя пользователя.
    Обе записи имеют формат Unicode wide-character строк. </p>
    <p>&nbsp;</p>
    <h2>Использование функции</h2>
    <p>Итак, при использовании данного сервиса
    рассмотрим три основных его составляющих: <ol>
      <li><div><p>Установка параметров, для передачи в
        функцию.</p>
        </div></li>
      <li><div><p>Вызов функции и получение результатов.</p>
        </div></li>
      <li><div><p>Обработка возможных ошибок.</p>
        </div></li>
    </ol>
    <p>Параметры устанавливаются следующим образом:</p>
    <pre><span class="cpp-comment">// Во-первых, нам необходимо наши строки в Unicode wide-character формат</span>
CString szServer = <span
class="cpp-string">&quot;\\\\MYSERVER&quot;</span>;    <span class="cpp-comment">// Сервер для запроса</span>
LPWSTR pWideServer;
<span
class="cpp-keyword">int</span> nBytesSource = strlen(pString) * <span class="cpp-literal">2</span>;
<span
class="cpp-comment">// Количество WChars необходимых для сохранения полученных данных</span>
<span
class="cpp-keyword">int</span> nWCharNeeded = MultiByteToWideChar (CP_ACP, MB_PRECOMPOSED,
                                     pString, nBytesSource, NULL, <span
class="cpp-literal">0</span>);

<span class="cpp-comment">// Распределяем необходимое пространство памяти плюс 2 байта для '\0'</span>
pWideServer = (LPWSTR)GlobalAlloc (GPTR, (nWCharNeeded + <span
class="cpp-literal">1</span>) * <span class="cpp-literal">2</span>);

<span class="cpp-comment">// Делаем преобразование</span>
nWCharNeeded = MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, pString,
    nBytesSource,(LPWSTR)pWideServer, nWCharNeeded);

<span
class="cpp-keyword">if</span> (<span class="cpp-literal">0L</span> == nWCharNeeded) {
    pWideServer = NULL;
}
<span
class="cpp-keyword">else</span> {
    *(LPWSTR)(pWideServer + nWCharNeeded) = L<span
class="cpp-string">'\0'</span>;
}
nIndex = <span class="cpp-literal">0</span>;        <span
class="cpp-comment">// Индекс внутри списка пользователей</span>
DWORD dwCount;        <span
class="cpp-comment">// Возвращённое количество ячеек</span>
<span
class="cpp-keyword">void</span>* pBuffer;        <span class="cpp-comment">// Буфер для хранения результатов</span>
NET_DISPLAY_USER* ndu;    <span
class="cpp-comment">// Информация о пользователе</span>
DWORD dwResult,  i;    <span
class="cpp-comment">// Код завершения и индекс</span>
</pre>
    <p>Далее, для получения результатов используем
    следующий код: </p>
    <pre><span class="cpp-keyword">do</span> {
    dwResult = NetQueryDisplayInformation ((LPCWSTR)pWideServer,
                              <span
class="cpp-literal">1</span>, nIndex, <span class="cpp-literal">10</span>, <span
class="cpp-literal">24</span>, &amp;dwCount, &amp;pBuffer);
    <span class="cpp-keyword">if</span> ((dwResult == ERROR_SUCCESS) || (dwResult == ERROR_MORE_DATA)) { 
        <span
class="cpp-keyword">for</span> (i = <span class="cpp-literal">0</span>, ndu = (NET_DISPLAY_USER*)pBuffer; i &lt; dwCount; ++i, ++ndu) {
            CString szName, szFullName, szComment;
            szName.Format(<span
class="cpp-string">&quot;%S&quot;</span>, ndu-&gt;usri1_name);
            szFullName.Format(<span
class="cpp-string">&quot;%S&quot;</span>, ndu-&gt;usri1_full_name);
            szComment.Format (<span
class="cpp-string">&quot;%S&quot;</span>, ndu-&gt;usri1_comment);
            TRACE (<span
class="cpp-string">&quot;Name:\t\t&quot;</span> + szName + <span class="cpp-string">&quot;\n&quot;</span>); 
            TRACE (<span
class="cpp-string">&quot;Full Name:\t&quot;</span> + szFullName + <span class="cpp-string">&quot;\n&quot;</span>); 
            TRACE (<span
class="cpp-string">&quot;Comment:\t&quot;</span> + szComment + <span class="cpp-string">&quot;\n&quot;</span>); 
            TRACE (<span
class="cpp-string">&quot;--------------------------------\n&quot;</span>);
            <span
class="cpp-keyword">if</span> (dwCount &gt;  <span class="cpp-literal">0</span>){
                nIndex = ((NET_DISPLAY_USER *)pBuffer)[dwCount - <span
class="cpp-literal">1</span>].usri1_next_index;
            }
        }
    }
} <span
class="cpp-keyword">while</span> (dwResult == ERROR_MORE_DATA);
</pre>
    <p>Первый раз функция NQDI делает запрос для индекса
    0. Далее индекс увеличивается до тех пор, пока не
    будет получено очередных данных о пользователе,
    либо не возникнет ошибка. Индекс следующего
    пользователя содержится в поле <code>usri1_next_index</code>
    структуры <code>NET_DISPLAY_USER</code>. </p>
    <pre>      
<span class="cpp-keyword">switch</span> (dwResult) { 
    <span
class="cpp-keyword">case</span> ERROR_ACCESS_DENIED: 
        TRACE (<span class="cpp-string">&quot;%s(%i): The user does not have access
                 to the requested information.\n&quot;</span>, __FILE__, __LINE__); 
        <span
class="cpp-keyword">break</span>; 
    <span class="cpp-keyword">case</span> ERROR_INVALID_LEVEL:
        TRACE (<span
class="cpp-string">&quot;%s(%i): The Level parameter specifies
                             an invalid value.\n&quot;</span>, __FILE__, __LINE__); 
        <span
class="cpp-keyword">break</span>;
    <span class="cpp-keyword">case</span> ERROR_MORE_DATA: 
        TRACE (<span
class="cpp-string">&quot;%s(%i): More entries are available.\n&quot;</span>, __FILE__, __LINE__); 
        <span
class="cpp-keyword">break</span>;
    <span class="cpp-keyword">case</span> ERROR_SUCCESS: 
        <span
class="cpp-comment">//    ничиго не делаем </span>
        <span
class="cpp-keyword">break</span>; 
    <span class="cpp-keyword">default</span>: {
        <span
class="cpp-comment">// Другие ошибки, возможно RPC related </span>
        LPVOID lpMsgBuf; <span
class="cpp-comment">// буфер для сообщения</span>
        ::FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |
            FORMAT_MESSAGE_FROM_SYSTEM,
            <span
class="cpp-literal">0</span>,
            dwResult, 
            MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), <span
class="cpp-comment">// Язык по умолчанию</span>
            (LPTSTR)&amp;lpMsgBuf, <span
class="cpp-literal">0</span>, NULL ); 
        TRACE (<span class="cpp-string">&quot;%s(%i): %s\n&quot;</span>, __FILE__, __LINE__, lpMsgBuf); 
        <span
class="cpp-comment">// Освобождаем буфер, который был выделен при помощи LocalAlloc() </span>
        ::LocalFree (lpMsgBuf);
        }
        <span
class="cpp-keyword">break</span>;
}
GlobalFree (pWideServer);
</pre>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <h2>Класс для использования данного сервиса</h2>
    <p>Как и все хорошие программисты, я не смог не
    создать для этой функции своего класса! Он имеет
    три основных статических функции и один
    дополнительный класс <code>CNetInfo</code>:</p>
    <pre><span class="cpp-keyword">static</span> DWORD GetUserInfo (USER_LIST* pUsers, LPCSTR pServer = NULL);
<span
class="cpp-keyword">static</span> DWORD GetMachineInfo (MACHINE_LIST* pMachines, LPCSTR pServer = NULL);
<span
class="cpp-keyword">static</span> DWORD GetGroupInfo (GROUP_LIST* pGroups, LPCSTR pServer = NULL); 
<span
class="cpp-keyword">static</span> CString FormatMessage (DWORD dwError);
</pre>
    <p>Первые три функции вызывают всё тот же NQDI.
    Последняя используется для для приёма сообщений
    об ошибках и возвращает строку, содержащую
    описание произошедшей ошибки.</p>
    <p>Типы USER_LIST, MACHINE_LIST и GROUP_LIST определены как:</p>
    <pre><span class="cpp-preprocessor">#define USER_LIST    CList&lt;NET_DISPLAY_USER, NET_DISPLAY_USER&amp;&gt;</span>
<span
class="cpp-preprocessor">#define MACHINE_LIST    CList&lt;NET_DISPLAY_MACHINE, NET_DISPLAY_MACHINE&amp;&gt;</span>
<span
class="cpp-preprocessor">#define GROUP_LIST    CList&lt;NET_DISPLAY_GROUP, NET_DISPLAY_GROUP&gt;</span>
</pre>
    <p>Так же определены уровни получаемой информации:</p>
    <pre><span class="cpp-preprocessor">#define LEVEL_USER    1</span>
<span
class="cpp-preprocessor">#define LEVEL_MACHINE    2</span>
<span class="cpp-preprocessor">#define LEVEL_GROUP    3</span>
</pre>
    <p>Для использования данного класса, нам
    необходимо создать список необходимых типов,
    передать указатель на него и имя сервера в
    требуемую функцию (определённую параметром level),
    а затем, в зависимости от результата, либо
    обработать полученные результаты, либо
    обработать сообщение об ошибке. Класс определён
    в именном пространстве <code>ssl_net</code>, так что
    необходимо добавить строчку <code><span class="cpp-keyword">using</span>
    <span class="cpp-keyword">namespace</span> ssl_net;</code>, либо вызывать
    функцию из класса, как это показано ниже: </p>
    <pre>USER_LIST pUsers = <span class="cpp-keyword">new</span> USER_LIST;
CString szServer = <span
class="cpp-string">&quot;\\\\MYSERVER&quot;</span>
DWORD dwResult = ssl_net::CNetInfo::GetUserInfo (pUsers, szServer);
<span
class="cpp-keyword">if</span> (ERROR_SUCCESS == dwResult) {
    <span class="cpp-comment">// Обрабатываем результаты</span>
    POSITION pos = pUsers-&gt;GetHeadPosition ();
    <span
class="cpp-keyword">while</span> (NULL != pos) {
        NET_DISPLAY_USER ndu = pUsers-&gt;GetNext (pos); 
        CString szName, szComment, szFlags, szFullName, szUserID; 
        szName.Format (<span
class="cpp-string">&quot;%S&quot;</span>, ndu.usri1_name);
        szComment.Format (<span
class="cpp-string">&quot;%S&quot;</span>, ndu.usri1_comment); 
        szFlags.Format (<span
class="cpp-string">&quot;%d&quot;</span>, ndu.usri1_flags); 
        szFullName.Format (<span
class="cpp-string">&quot;%S&quot;</span>,n du.usri1_full_name); 
        szUserID.Format (<span
class="cpp-string">&quot;%d&quot;</span>, ndu.usri1_user_id);
        TRACE (<span
class="cpp-string">&quot;%S\n%S\n%d\n%S\n%d\n&quot;</span>, ndu.usri1_name,
            ndu.usri1_comment, ndu.usri1_flags,
            ndu.usri1_full_name, ndu.usri1_user_id);
    }
}
<span
class="cpp-keyword">else</span> {
    <span class="cpp-comment">// Обрабатываем ошибки</span>
    CString szErrMsg = ssl_net::CNetInfo::FormatMessage (dwResult);
    AfxMessageBox (szErrMsg);
}
<span
class="cpp-keyword">delete</span> pUsers;
</pre>
    <p>Теперь для того, чтобы это всё заработало,
    достаточно включить в проект NetInfo.h и
    прилинковать NetApi32.lib.</p>
    <p>Приведённый пример был написан на Visual C++ 6 SP4, но
    думаю, что код должен работать с различными
    модификациями VC6 или сервиспаков. Тестирование
    проводилось только на Windows NT 4 SP6a. В документации
    сказано, что функция NQDI поддерживается в Windows NT 3.1
    или поздних версиях (включая Windows 2000), но не
    поддерживается в Windows 95 или 98.</p>
    <p>&nbsp;</td>
  </tr>
</table>
</center></div>


<hr>
<div align="center"><center>

<table border="0" cellpadding="0" cellspacing="3" width="468">
  <tr>
    <td width="154"><!-- LBE_LITE --> <script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://lite.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://lite.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE_LITE ismap></a><br>");
// -->
</script> <noscript> <br>
</noscript><!-- LBE_LITE --></td>
  </tr>
</table>
</center></div>
</body>
</html>
