<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<style type="text/css">
A.black:link {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:visited {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:hover {COLOR: #FFFFFF; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
.b {text-decoration: none; color:#FF0000;} 
.b:hover {color:#7785FF;}
.c {text-decoration: none; color:#000000;} 
.c:hover {color:#FFFFFF;}
 pre {color: blue;}
TD.colon {COLOR: #000000; FONT-FAMILY: "MS Sans Serif", sans-serif; FONT-SIZE: 9pt}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta content="программирование на Visual Basic, документация, документы, delphi, pascal, cpp, hardware, web, веб-мастер, советы, описания, доки, manual, Java, C, C++, обучение, исходники, odbc, jdbc, programm, protocols, протоколы, общение, форумapplet, java, design, апплет, дизайн, ява, Free, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources" name="keywords">
<meta NAME="RESOURCE-TYPE"
CONTENT="pop hypertext sources hypermedia server scripting shtml phtml html developer code base tools open source web site browser free software webmaster cgi dhtml dynamic content netscape explorer shareware download website construction free tutorial news design maintenance page hit cvs mailing list projects httpd mod_perl mod www htdig xml perl scripts script server-side-include apache database MySQL mysql msql postres postresql module linux online cpp Visual Basic JavaScript delphi wap job informer java opengl directx">
<title>Информационный сервер для программистов - исходники со всего света.</title>
</head>

<body topmargin="0" leftmargin="0" marginwidth="0" marginheigth="0" bgcolor=white>

<form action="/cgi-bin/sources/search/search.pl" method="get" align="left">
  <input type="hidden" name="stpos" value="0"><table border="0" cellpadding="0"
  cellspacing="0" width="750">
    <tr>
      <td valign="top" rowspan="2"><table border="0" cellpadding="0" cellspacing="0" width="287">
        <tr>
          <td colspan="2" bgcolor="#A5E4A7" valign="middle" align="center"><b>WWW.ИСХОДНИКИ.РУ</b></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">cpp.sources.ru</font></b></td>
        </tr>
        <tr>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">java.sources.ru</font></b></td>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>web.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>soft.sources.ru</b></font></td>
        </tr>
        <tr>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>jdbc.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>asp.sources.ru</b></font></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">api.sources.ru</font></b></td>
        </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td><font style="font-size: 8pt" size="2" face="Tahoma">&nbsp; Поиск по
          программированию :<br>
          </font>&nbsp; <input type="text" size="13" name="query"> <input type="submit"
          value="Поиск"><font size="1"><input
          TYPE="Radio" NAME="stype" VALUE="AND" checked>&quot;AND&quot; <input TYPE="Radio"
          NAME="stype" VALUE="OR">&quot;OR&quot;</font>


<!--TopList COUNTER--><a target=_top
href="http://top.list.ru/jump?from=89876"><script language="JavaScript"><!--
d=document;a='';a+=';r='+escape(d.referrer)
js=10//--></script><script language="JavaScript1.1"><!--
a+=';j='+navigator.javaEnabled()
js=11//--></script><script language="JavaScript1.2"><!--
s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
js=12//--></script><script language="JavaScript1.3"><!--
js=13//--></script><script language="JavaScript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=89876;t=57;js='+js+a+';rand='+Math.random()+
'" alt="TopList" '+ 'border=0 height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=89876;t=57"
border=0 height=1 width=1
alt="TopList"></noscript><script language="JavaScript"><!--
if(js>11)d.write('--'+'>')//--></script></a><!--TopList COUNTER-->


<a href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?163871" alt="Rambler's Top100" width=1 height=1 border=0></a>

<!-- SpyLOG f:0211 --> 
<script language="javascript"> 
u="u1624.10.spylog.com";d=document;nv=navigator;na=nv.appName;p=1; 
bv=Math.round(parseFloat(nv.appVersion)*100); 
n=(na.substring(0,2)=="Mi")?0:1;rn=Math.random();z="p="+p+"&rn="+rn;y=""; 
y+="<a href='http://"+u+"/cnt?f=3&p="+p+"&rn="+rn+"' target=_blank>"; 
y+="<img src='http://"+u+"/cnt?"+z+ "&r="+escape(d.referrer)+"&pg="+escape(window.location.href)+"' border=0 width=1 height=1 alt='SpyLOG'>"; 
y+="</a>"; d.write(y);if(!n) { d.write("<"+"!--"); }//--></script><noscript> 
<a href="http://u1624.10.spylog.com/cnt?f=3&p=1" target=_blank> 
<img src="http://u1624.10.spylog.com/cnt?p=1" alt='SpyLOG' border='0' width=1 height=1 > 
</a></noscript><script language="javascript1.2"><!-- 
if(!n) { d.write("--"+">"); }//--></script> 
<!-- SpyLOG -->


</td>
        </tr>
      </table>
      </td>
      <td align="center"><font style="font-size: 15pt" color="#4904B1" size="4"
      face="Times New Roman">Информационный сервер</font></td>
    </tr>
    <tr>
      <td>


<!-- LBE -->
<script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://www.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://www.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE ismap></a><br>");
// -->
</script>
<noscript>
                                                                                                                                                                <br>
</noscript>
<!-- LBE -->



      </td>
    </tr>
    <tr>
      <td colspan="2"><table border="0" cellpadding="0" cellspacing="1" width="100%">
        <tr>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a
          href="../www.sources.html"><font color="#000000" size="2">На главную</font></a></td>
          <td align="center" width="20%" bgcolor="#E0E0C6"><a
          href="../subscribe.html"><font color="#000000" size="2">Подписаться на новости</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../cgi-bin/sources/Ultimate.pl"><font color="#000000" size="2">Форум</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../books.html"><font color="#000000" size="2">Книги</font></a></td>
          <td align="center" width="7%" bgcolor="#E0E0C6"><a href="http://chat.vidcenter.ru:82/"><font color="#000000" size="2">Чат</font></a></td>
          <td align="center" width="13%" bgcolor="#E0E0C6"><a href="http://www.countries.ru/"><font color="#000000" size="2">Страны мира</font></a></td>
          <td align="center" width="29%" bgcolor="#E0E0C6"><b>4</b> пользователей на сервере.
</td>
        </tr>
      </table>
      </td>
    </tr>
  </table>
</form>

<div align="center"><center>

<table width="680" cellspacing="0" cellpadding="0">
  <tr>
    <td><hr>
    <p>Ниже приводится полный исходный текст функции
    DoPingOperation. </p>
    <pre>
BOOL DoPingOperation(HANDLE hInstance)
  {
                                 // Локальные переменные
    int iPacketSize;             // размер ICMP-пакета
    int iHostAddrLength;         // Длина адреса сетевого компьютера
    int iIPHeadLength;           // Длина заголовка IP-датаграммы
    int iReceivedBytes;          // Количество принятых байтов
    int iSentBytes;              // Количество посланных байтов
    int nProtocol;               // Номер протокола ICMP
    int iSocketError;            // Значение кода ошибки
    PDWORD pdwTimeStamp;         // Счетчик &quot;тиков&quot; при передаче
    DWORD dwReturnTime;          // Счетчик &quot;тиков&quot; при приеме
    DWORD dwRoundTrip;           // Счетчик &quot;тиков&quot; среднего времени &quot;Пробега

                                 // Структуры, описанные в WINSOCK.H 
    SOCKADDR_IN sockAddrLocal;   // Структуры адреса сокета 
    SOCKADDR_IN sockAddrHost;    // 
    SOCKET hSocket;              // Дескриптор сокета 
    LPHOSTENT IpHostEntry;       // Структура данных с
                                 // информацией о сетевом компьютере
    LPPROTOENT IpProtocolEntry;  // Структура данных с информацией о протоколе

    BYTE IcmpSendPacket[1024];   // Буфер для посылаемых данных
    BYTE IcmpRecvPacket[4096];   // Буфер для принимаемых данных

    struct icmp *pIcmpHeader;    // Указатель на структуру ICMP
    struct ip *pIpHeader;        // Указатель на структуру-заголовок IP
    LPSTR IpszHostName;          // Указатель на удаленный сервер времени

    IpszHostName = HOST_NAME;
    if ((IpHostEntry = gethostbyname(HOST_NAME)) == NULL)  {
        wsprintf(szPingBuffer, &quot;Could not get %s IP address.&quot;, (LPSTR)IpszHostName);
        return(FALSE) ;
    }

    sockAddrLocal,sin_family = AF_INET;
    sockAddrLocal.sin_addr = *((LPIN_ADDR)*lpHostEntry-&gt;h_addr_list) ;

    // В случае простого сокета, мы должны указывать протокол
    if ((IpProtocolEntry = getprotobyname(&quot;icmp&quot;)) == NULL)
         nProtocol = IPPROTO_ICMP;
    else
         nProtocol = !pProtocolEntry-&gt;p_proto;

    // Создаем простой сокет и указываем ICMP в качестве протокола

    if ((hSocket = socket(AF_INET, SOCK_RAW, nProtocol)) == INVALID_SOCKET)  {
         wsprintf(szPingBuffer, &quot;Could not create a RAW socket.&quot;);
         return(FALSE) ;
    }

    pIcmpHeader = (struct icmp *) IcmpSendPacket;

    // Указываем на область данных и заполняем ее
    pIcmpHeader-&gt;icmp_type = IСМР_ЕСНО;
    pIcmpHeader-&gt;icmp_code = 0;
    // Берем дескриптор задания в качестве уникального идентификатора
    pIcmpHeader-&gt;icmp_id = hInstance;
    pIcmpHeader-&gt;icmp_seq =0;            // Помним, что контрольную
    pIcmpHeader-&gt;icmp_cksum = 0;         // сумму необходимо
                                            // предварительно обнулить

    // Значение счетчика &quot;тиков&quot; располагается в необязательной области данных
    pdwTimeStamp = (PDWORD)&amp;IcmpSendPacket[ICMP_HEADERSIZE];
    *pdwTimeStamp = GetTickCount();
    iPacketSize = ICMP_HEADERSIZE + sizeof(DWORD) ;
    pIcmpHeader-&gt;icmp_cksum = InternetChksum((LPWORD)pIcmpHeader, iPacketSize);

    if (pIcmpHeader-&gt;icmp_cksum !=0 )  {
        iSentBytes = sendto(hSocket, (LPSTR) IcmpSendPacket,
                         iPacketSize, NO_FLAGS, (LPSOCKADDR) &amp;sockAddrLocal,
                         sizeof(sockAddrLocal));

        if (iSentBytes == SOCKET_ERROR)  {
           closesocket(hSocket) ;
           wsprintf(szPingBuffer, &quot;The sendto() function returned a socket error.&quot;);
           return(FALSE);
        }

        if (iSentBytes i= iPacketSize)  {
           closesocket(hSocket);
           wsprintf(szPingBuffer, &quot;Wrong number of bytes sent: %d&quot;, iSentBytes);
           return(FALSE);
        }

        iHostAddrLength = sizeof(sockAddrHost);

        iReceivedBytes = recvfrom( hSocket, (LPSTR)IcmpRecvPacket,
                             sizeof(IcmpRecvPacket), NO_FLAGS, (LPSOCKADDR)
                             &amp;sockAddrHost, &amp;iHostAddrLength);
   }
   else  {
        closesocket(hSocket);
        wsprintf(szPingBuffer, &quot;Checksum computation error! Result was zero!&quot;);
        return(FALSE);
   }

   closesocket(hSocket) ;

   if (iReceivedBytes == SOCKET_ERROR)  {
       iSocketError = WSAGetLastError();
       if (iSocketError == 10004)  {
            wsprintf(szPingBuffer, &quot;Ping operation for %s was cancelled &quot;, (LPSTR)lpszHostName);                 '
            dwRoundTrip = 0;
            return(TRUE);
       }
       else  {
            wsprintf(szPingBuffer, &quot;Socket Error from recvfrom(): %d&quot;, iSocketError);
            return(FALSE);
       }
   }

   dwReturnTime = GetTickCount();
   dwRoundTrip = dwReturnTime - *pdwTimeStamp;

   // Указываем на IP-заголовок принятого пакета
   pIpHeader = (struct ip *)IcmpRecvPacket;

   // Извлекаем биты 4-7 и преобразуем количество З2-битных
   // слов в количество байтов

   iIPHeadLength = (pIpHeader-&gt;ip_verlen » 4) « 2;

   // Проверяем длину, чтобы удостовериться, что ICMP-заголовок принят

   if (iReceivedBytes &lt; iIPHeadLength + ICMP_HEADERSIZE)  {
      wsprintf(szPingBuffer, &quot;Received packet was too short.&quot;);
      return(FALSE);
   }

   // Указываем на ICMP-сообщение, следующее сразу за IP-заголовком
   pIcmpHeader = (struct icmp *) (IcmpRecvPacket + iIPHeadLength);

   // Проверяем, что мы приняли именно &quot;эхо&quot;-ответ
   if (pIcmpHeader-&gt;icmp_type != ICMP_ECHOREPLY)  {
      wsprintf(szPingBuffer, &quot;Received packet was not an echo reply to your ping.&quot;);
      return(FALSE);
   }

   // Проверяем, принадлежит ли этот пакет нашей программе
   if (pIcmpHeader-&gt;icmp_id != (WORD)hInstance)  {
      wsprintf(szPingBuffer, &quot;Received packet was not sent by this program.&quot;);
      return(FALSE);
   }

   // Да, этот пакет был послан нашей программой. Обратите
   // внимание на IP-адрес и имя удаленного компьютера,
   // пославшего &quot;эхо&quot;-ответ
   lstrcpy( lpszHostName, (LPSTR) !pHostEntry-&gt;h_name) ;
   wsprintf(szPingBuffer, &quot;Round-trip travel time to %s [%s] was %d milliseconds.&quot;,
         (LPSTR)IpszHostName,
         (LPSTR)inet_ntoa(sockAddrHost.sin_addr),
         dwRoundTrip);

   return(TRUE);
}
	</pre>
    </td>
  </tr>
</table>
</center></div>


<hr>
<div align="center"><center>

<table border="0" cellpadding="0" cellspacing="3" width="468">
  <tr>
    <td width="154"><!-- LBE_LITE --> <script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://lite.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://lite.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE_LITE ismap></a><br>");
// -->
</script> <noscript> <br>
</noscript><!-- LBE_LITE --></td>
  </tr>
</table>
</center></div>
</body>
</html>
