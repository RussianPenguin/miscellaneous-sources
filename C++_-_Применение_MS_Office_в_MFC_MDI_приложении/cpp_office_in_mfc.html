<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<style type="text/css">
A.black:link {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:visited {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:hover {COLOR: #FFFFFF; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
.b {text-decoration: none; color:#FF0000;} 
.b:hover {color:#7785FF;}
.c {text-decoration: none; color:#000000;} 
.c:hover {color:#FFFFFF;}
 pre {color: blue;}
TD.colon {COLOR: #000000; FONT-FAMILY: "MS Sans Serif", sans-serif; FONT-SIZE: 9pt}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta content="программирование на Visual Basic, документация, документы, delphi, pascal, cpp, hardware, web, веб-мастер, советы, описания, доки, manual, Java, C, C++, обучение, исходники, odbc, jdbc, programm, protocols, протоколы, общение, форумapplet, java, design, апплет, дизайн, ява, Free, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources" name="keywords">
<meta NAME="RESOURCE-TYPE"
CONTENT="pop hypertext sources hypermedia server scripting shtml phtml html developer code base tools open source web site browser free software webmaster cgi dhtml dynamic content netscape explorer shareware download website construction free tutorial news design maintenance page hit cvs mailing list projects httpd mod_perl mod www htdig xml perl scripts script server-side-include apache database MySQL mysql msql postres postresql module linux online cpp Visual Basic JavaScript delphi wap job informer java opengl directx">
<title>Информационный сервер для программистов - исходники со всего света.</title>
</head>

<body topmargin="0" leftmargin="0" marginwidth="0" marginheigth="0" bgcolor=white>

<form action="/cgi-bin/sources/search/search.pl" method="get" align="left">
  <input type="hidden" name="stpos" value="0"><table border="0" cellpadding="0"
  cellspacing="0" width="750">
    <tr>
      <td valign="top" rowspan="2"><table border="0" cellpadding="0" cellspacing="0" width="287">
        <tr>
          <td colspan="2" bgcolor="#A5E4A7" valign="middle" align="center"><b>WWW.ИСХОДНИКИ.РУ</b></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">cpp.sources.ru</font></b></td>
        </tr>
        <tr>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">java.sources.ru</font></b></td>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>web.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>soft.sources.ru</b></font></td>
        </tr>
        <tr>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>jdbc.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>asp.sources.ru</b></font></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">api.sources.ru</font></b></td>
        </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td><font style="font-size: 8pt" size="2" face="Tahoma">&nbsp; Поиск по
          программированию :<br>
          </font>&nbsp; <input type="text" size="13" name="query"> <input type="submit"
          value="Поиск"><font size="1"><input
          TYPE="Radio" NAME="stype" VALUE="AND" checked>&quot;AND&quot; <input TYPE="Radio"
          NAME="stype" VALUE="OR">&quot;OR&quot;</font>


<!--TopList COUNTER--><a target=_top
href="http://top.list.ru/jump?from=89876"><script language="JavaScript"><!--
d=document;a='';a+=';r='+escape(d.referrer)
js=10//--></script><script language="JavaScript1.1"><!--
a+=';j='+navigator.javaEnabled()
js=11//--></script><script language="JavaScript1.2"><!--
s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
js=12//--></script><script language="JavaScript1.3"><!--
js=13//--></script><script language="JavaScript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=89876;t=57;js='+js+a+';rand='+Math.random()+
'" alt="TopList" '+ 'border=0 height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=89876;t=57"
border=0 height=1 width=1
alt="TopList"></noscript><script language="JavaScript"><!--
if(js>11)d.write('--'+'>')//--></script></a><!--TopList COUNTER-->


<a href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?163871" alt="Rambler's Top100" width=1 height=1 border=0></a>

<!-- SpyLOG f:0211 --> 
<script language="javascript"> 
u="u1624.10.spylog.com";d=document;nv=navigator;na=nv.appName;p=1; 
bv=Math.round(parseFloat(nv.appVersion)*100); 
n=(na.substring(0,2)=="Mi")?0:1;rn=Math.random();z="p="+p+"&rn="+rn;y=""; 
y+="<a href='http://"+u+"/cnt?f=3&p="+p+"&rn="+rn+"' target=_blank>"; 
y+="<img src='http://"+u+"/cnt?"+z+ "&r="+escape(d.referrer)+"&pg="+escape(window.location.href)+"' border=0 width=1 height=1 alt='SpyLOG'>"; 
y+="</a>"; d.write(y);if(!n) { d.write("<"+"!--"); }//--></script><noscript> 
<a href="http://u1624.10.spylog.com/cnt?f=3&p=1" target=_blank> 
<img src="http://u1624.10.spylog.com/cnt?p=1" alt='SpyLOG' border='0' width=1 height=1 > 
</a></noscript><script language="javascript1.2"><!-- 
if(!n) { d.write("--"+">"); }//--></script> 
<!-- SpyLOG -->


</td>
        </tr>
      </table>
      </td>
      <td align="center"><font style="font-size: 15pt" color="#4904B1" size="4"
      face="Times New Roman">Информационный сервер</font></td>
    </tr>
    <tr>
      <td>


<!-- LBE -->
<script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://www.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://www.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE ismap></a><br>");
// -->
</script>
<noscript>
                                                                                                                                                                <br>
</noscript>
<!-- LBE -->



      </td>
    </tr>
    <tr>
      <td colspan="2"><table border="0" cellpadding="0" cellspacing="1" width="100%">
        <tr>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a
          href="../www.sources.html"><font color="#000000" size="2">На главную</font></a></td>
          <td align="center" width="20%" bgcolor="#E0E0C6"><a
          href="../subscribe.html"><font color="#000000" size="2">Подписаться на новости</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../cgi-bin/sources/Ultimate.pl"><font color="#000000" size="2">Форум</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../books.html"><font color="#000000" size="2">Книги</font></a></td>
          <td align="center" width="7%" bgcolor="#E0E0C6"><a href="http://chat.vidcenter.ru:82/"><font color="#000000" size="2">Чат</font></a></td>
          <td align="center" width="13%" bgcolor="#E0E0C6"><a href="http://www.countries.ru/"><font color="#000000" size="2">Страны мира</font></a></td>
          <td align="center" width="29%" bgcolor="#E0E0C6"><b>7</b> пользователей на сервере.
</td>
        </tr>
      </table>
      </td>
    </tr>
  </table>
</form>

<div align="center"><center>

<table width="680" cellspacing="0" cellpadding="0">
  <tr>
    <td><hr>
    <h3 align="center"><font color="#a0a099">Применение MS Office в MFC MDI приложении</font></h3>
    <hr>
    <p>Автор: <a href="mailto:it@hotmail.ru?Subject=XOffice">Igor Tkachev</a>. <!-- Sample image - gif or jpg --> </p>
    <p><img src="XOffice.jpg" width="460" height="330"></p>
<P>Зачем?<BR>
Однажды я занимался проектом, главной особенностью которого было наличие
не детского количества типовых форм ввода и вывода.
Что-то типа делопроизводства. Документы должны были заполняться данными
из БД или другими данными,  которые может предоставить программа.
При этом было бы крайне желательно, чтобы шаблон документа мог разобратьс
с этими данными самостоятельно.

<P>
Оказалось, что всем этим требованиям удовлетворяет MS Office.

<P>
В этой статье я попытаюсь это продемонстрировать.

<P>
Сразу замечу, что самой большой проблемой была нестабильная работа самого
MS Office в режиме ActiveX Document. Поэтому, вы заметите некоторые явно
не оптимальные решения, но это на первый взгляд. Например, пришлось
отказаться от прямого вызова макросов VBA, т.к. после завершения программы
MS Office оставался в памяти, и снять его можно было только диспетчером
задач, ну и т.п.
Если вам удастся решить эту проблему, прошу поделиться со мной.

<P>Начнем.

<P><B>1. </B>
Сгенерируйте новое MDI приложение при помощи MFC
AppWizard. Назовите проект XOffice и на третьем шаге обязательно установите
флажки Container и Active document container.

<P><B>2. </B>
Приложение должно быть сервером автоматизации. Я воспользовался способом,
предложенным Nick Hodapp в примере AutoATL, который можно найти на
<A href="http://www.codeguru.com/atl/AutoATL.shtml">www.codeguru.com</A>.
Ознакомьтесь с этим примером и выполните все шаги по преобразованию
программы в сервер автоматизации.

<P><B>3. </B>
Теперь займемся подключением MS Office.
Включите в проект файл Office.h следующего содержания:

<PRE><TT><HR><FONT color=green>// Office.h</FONT>

<FONT color=blue>#define</FONT> Uses_MSO2000

<FONT color=blue>#ifdef</FONT> Uses_MSO2000
<FONT color=green>// for MS Office 2000</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSO9.DLL"</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Common Files\Microsoft Shared\VBA\VBA6\VBE6EXT.OLB"</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSWORD9.OLB"</FONT> \
        rename(<FONT color=teal>"ExitWindows"</FONT>,<FONT color=teal>"_ExitWindows"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\EXCEL9.OLB"</FONT> \
        rename(<FONT color=teal>"DialogBox"</FONT>,<FONT color=teal>"_DialogBox"</FONT>) \
        rename(<FONT color=teal>"RGB"</FONT>,<FONT color=teal>"_RGB"</FONT>) \
        exclude(<FONT color=teal>"IFont"</FONT>,<FONT color=teal>"IPicture"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Common Files\Microsoft Shared\DAO\DAO360.DLL"</FONT> \
        rename(<FONT color=teal>"EOF"</FONT>,<FONT color=teal>"EndOfFile"</FONT>) rename(<FONT color=teal>"BOF"</FONT>,<FONT color=teal>"BegOfFile"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSACC9.OLB"</FONT>
<FONT color=blue>#else</FONT>
<FONT color=green>// for MS Office 97</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSO97.DLL"</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Common Files\Microsoft Shared\VBA\VBEEXT1.OLB"</FONT>
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSWORD8.OLB"</FONT> \
        rename(<FONT color=teal>"ExitWindows"</FONT>,<FONT color=teal>"_ExitWindows"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\EXCEL8.OLB"</FONT> \
        rename(<FONT color=teal>"DialogBox"</FONT>,<FONT color=teal>"_DialogBox"</FONT>) \
        rename(<FONT color=teal>"RGB"</FONT>,<FONT color=teal>"_RGB"</FONT>) \
        exclude(<FONT color=teal>"IFont"</FONT>,<FONT color=teal>"IPicture"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Common Files\Microsoft Shared\DAO\DAO350.DLL"</FONT> \
        rename(<FONT color=teal>"EOF"</FONT>,<FONT color=teal>"EndOfFile"</FONT>)
        rename(<FONT color=teal>"BOF"</FONT>,<FONT color=teal>"BegOfFile"</FONT>)
<FONT color=blue>#import </FONT><FONT color=teal>"C:\Program Files\Microsoft Office\Office\MSACC8.OLB"</FONT>
<FONT color=blue>#endif</FONT>
<HR></TT></PRE>

<P><B>4. </B>
Создадим новую форму, которая нам понадобится в дальнейшем.
Menu – Insert – New Form…
<P>
В поле <B>Name</B> введите <B>CFormDemo</B>.
Нажмите кнопку <B>New </B>возле поля <B>Document </B>
и в появившейся форме OK. И еще раз OK.
<P>
На новой форме разместим три Edit Box'а и два Button'а.
В ClassWizard'е привяжем Edit Box'ы к переменным (соответственно
CString m_str, double m_double, long m_long).

<P><B>5. </B>
Для Button'ов создадим обработчики следующего вида:

<PRE><TT><HR><FONT color=green>// FormDemo.cpp</FONT>

<FONT color=blue>void </FONT>NewXOfficeDoc(LPCTSTR,LPCTSTR,<FONT color=blue>double</FONT>,<FONT color=blue>long</FONT>);

<FONT color=blue>void</FONT> CFormDemo::OnButton1()
{
    UpdateData();
    NewXOfficeDoc(<FONT color=teal>"XOffice.doc"</FONT>,m_str,m_double,m_long);
}

<FONT color=blue>void</FONT> CFormDemo::OnButton2()
{
    UpdateData();
    NewXOfficeDoc(<FONT color=teal>"XOffice.xls"</FONT>,m_str,m_double,m_long);
}
<HR></TT></PRE>

<P>
В начало файла XOfficeDoc.cpp добавим следующий код:

<PRE><TT><HR><FONT color=green>// XOfficeDoc.cpp</FONT>

<FONT color=blue>static </FONT>CString g_template;
<FONT color=blue>static </FONT>CString g_str;
<FONT color=blue>static double</FONT>  g_double;
<FONT color=blue>static long</FONT>    g_long;

<FONT color=blue>void</FONT> NewXOfficeDoc(LPCTSTR aTemplate,LPCTSTR aStr,
                   <FONT color=blue>double </FONT>aDouble,<FONT color=blue>long </FONT>aLong)
{
    CString   str;
    POSITION  pos = AfxGetApp()-&gt;GetFirstDocTemplatePosition();
    <FONT color=blue>while </FONT>(pos != NULL) {
	   CDocTemplate *temp = AfxGetApp()-&gt;GetNextDocTemplate(pos);
        if (temp-&gt;GetDocString(str,CDocTemplate::docName) {
            str == _T(<FONT color=teal>"XOffice"</FONT>)) {
            g_template = aTemplate;
            g_str      = aStr;
            g_double   = aDouble;
            g_long     = aLong;
            temp-&gt;OpenDocumentFile(NULL);
            <FONT color=blue>return</FONT>;
        }
    }
}
<HR></TT></PRE>

<P>
Теперь мы умеет создавать MDI документы по нажатию кнопок на форме.

<P><B>6. </B>
За поддержку включения ActiveX документов в MFC отвечает класс
<B>COleDocObjectItem</B>. Он уже многое умеет, но нам нужно ещё научить
его загружать документы, задаваемые нами.
<P>
Внесите следующие изменения в класс <B>CXOfficeCntrItem</B>:

<PRE><TT><HR><FONT color=green>// CntrItem.h</FONT>

<FONT color=blue>class</FONT> CXOfficeCntrItem : <FONT color=blue>public</FONT> ColeDocObjectItem
{
...
<FONT color=blue>public</FONT>:
<B>    CXOfficeCntrItem(CXOfficeDoc* pContainer,LPCTSTR);
    <FONT color=blue>bool</FONT> m_isCreate;
    <FONT color=blue>bool</FONT> CreateItem(LPCTSTR);</B>
...
};
<HR>
<FONT color=green>// CntrItem.cpp</FONT>

CXOfficeCntrItem::CXOfficeCntrItem(CXOfficeDoc* pContainer,LPCTSTR templ)
    : COleDocObjectItem(pContainer), m_isCreate(<FONT color=blue>false</FONT>)
{
    CreateItem(templ);
}

<FONT color=blue>bool </FONT> CXOfficeCntrItem::CreateItem(LPCTSTR templ)
{
    USES_CONVERSION;

    <FONT color=green>// get storage for the object via virtual function call</FONT>
    m_dwItemNumber = GetNewItemNumber();
    GetItemStorage();

    <FONT color=green>// add AfxOleInit(); in CXOfficeApp::InitInstance</FONT>
    AfxOleGetMessageFilter()-&gt;EnableNotRespondingDialog(FALSE);

    <FONT color=green>// attempt to create the object</FONT>
    LPOLECLIENTSITE lpClientSite = GetClientSite();
    SCODE sc = ::OleCreateFromFile(CLSID_NULL,
                                   T2COLE(templ),
                                   IID_IUnknown,
                                   OLERENDER_DRAW,
                                   NULL,
                                   lpClientSite,
                                   m_lpStorage,
                                  (LPVOID*)&amp;m_lpObject);
    <FONT color=blue>return</FONT> m_isCreate = FinishCreate(sc) == TRUE;
}
<HR></TT></PRE>

<P><B>7. </B>
И последнее, что нужно сделать – это внести изменения в классы
<B>CXOfficeDoc </B>и <B>CXOfficeView</B> для отображения ActiveX документа

<PRE><TT><HR><FONT color=green>// CntrItem.h</FONT>

<FONT color=blue>class</FONT> CXOfficeCntrItem : <FONT color=blue>public</FONT> ColeDocObjectItem
{
...
<FONT color=blue>public</FONT>:
<B>    CXOfficeCntrItem(CXOfficeDoc* pContainer,LPCTSTR);
    <FONT color=blue>bool</FONT> m_isCreate;
    <FONT color=blue>bool</FONT> CreateItem(LPCTSTR);</B>
...
};
<HR>
<FONT color=green>// CntrItem.cpp</FONT>

CXOfficeCntrItem::CXOfficeCntrItem(CXOfficeDoc* pContainer,LPCTSTR templ)
    : COleDocObjectItem(pContainer), m_isCreate(<FONT color=blue>false</FONT>)
{
    CreateItem(templ);
}

<FONT color=blue>bool </FONT> CXOfficeCntrItem::CreateItem(LPCTSTR templ)
{
    USES_CONVERSION;

    <FONT color=green>// get storage for the object via virtual function call</FONT>
    m_dwItemNumber = GetNewItemNumber();
    GetItemStorage();

    <FONT color=green>// add AfxOleInit(); in CXOfficeApp::InitInstance</FONT>
    AfxOleGetMessageFilter()-&gt;EnableNotRespondingDialog(FALSE);

    <FONT color=green>// attempt to create the object</FONT>
    LPOLECLIENTSITE lpClientSite = GetClientSite();
    SCODE sc = ::OleCreateFromFile(CLSID_NULL,
                                   T2COLE(templ),
                                   IID_IUnknown,
                                   OLERENDER_DRAW,
                                   NULL,
                                   lpClientSite,
                                   m_lpStorage,
                                  (LPVOID*)&amp;m_lpObject);
    <FONT color=blue>return</FONT> m_isCreate = FinishCreate(sc) == TRUE;
}
<HR></TT></PRE>

<P>
Итак, теперь мы умеем программно загружать ActiveX
документы. Это уже не плохо само по себе. <FONT face=Wingdings>J</FONT>
<P>
Обратите внимание, что процедуры сохранения и загрузки <B>наших</B>
документов тоже нормально работают, сохраняя при этом содержимое исходного
документа шаблона, правда это совсем не входит в наши планы. Единственное,
что не работает – это Print Preview. Я так и не смог с этим разобраться,
посему, если у кого-то это получится, буду рад узнать об этом первым.

<P><B>8. </B>
Теперь научим класс <B>CXOfficeDoc</B> сохранять и загружать <B>только</B>
наши данные и не задавать вопросы при изменении данных самого ActiveX
документа. Для этого с помощью ClassWizard'а добавьте методы
<B>OnOpenDocument</B> и <B>SaveModified </B>и внесите следующие изменения:

<PRE><TT><HR><FONT color=green>// XOfficeDoc.cpp</FONT>

<FONT color=blue>void </FONT> CXOfficeDoc::Serialize(CArchive&amp; ar)
{
    <FONT color=blue>if </FONT>(ar.IsStoring()) {
<B>        ar &lt;&lt; m_template &lt;&lt; m_str &lt;&lt; m_double &lt;&lt; m_long;</B>
    } <FONT color=blue>else </FONT> {
<B>        ar &gt;&gt; m_template &gt;&gt; m_str &gt;&gt; m_double &gt;&gt; m_long;</B>
    }
<FONT color=green><B>//    COleDocument::Serialize(ar);</B></FONT>
}

BOOL CXOfficeDoc::OnOpenDocument(LPCTSTR lpszPathName)
{
    <FONT color=blue>if </FONT>(!COleDocument::OnOpenDocument(lpszPathName))
        <FONT color=blue>return </FONT>FALSE;
<B>    <FONT color=blue>return </FONT>LoadTemplate();</B>
}

BOOL CXOfficeDoc::SaveModified()
{
    <FONT color=blue>return </FONT>CDocument::SaveModified();</B>
}
<HR>
<FONT color=green>// CntrItem.cpp</FONT>

<FONT color=blue>void </FONT> CXOfficeCntrItem::OnChange(OLE_NOTIFICATION nCode, DWORD dwParam)
{
<B>    BOOL modified = m_pDocument-&gt;IsModified();</B>
    COleDocObjectItem::OnChange(nCode, dwParam);
<B>    m_pDocument-&gt;SetModifiedFlag(modified);</B>

    GetDocument()-&gt;UpdateAllViews(NULL);
}
<HR></TT></PRE>

<P><B>9. </B>
Следующим шагом будет получение интерфейса <B>IDispatch</B> ActiveX документа.
Внесем следующие изменени в класс <B>CXOfficeCntrItem</B>:

<PRE><TT><HR><FONT color=green>// CntrItem.h</FONT>
...
<B><FONT color=blue>#include </FONT>&lt;comdef.h&gt; <comdef.h></B>
...
<FONT color=blue>class </FONT>CXOfficeCntrItem : <FONT color=blue>public </FONT>COleDocObjectItem
{
<FONT color=blue>public</FONT>:
...<B>
    <FONT color=blue>int          </FONT>m_who;      // 0 - ?, 1 - Word, 2 - Excel
    IDispatchPtr m_disp;

    LPDISPATCH   GetIDispatch();
    <FONT color=blue>void         </FONT>AttachDisp  ();
    <FONT color=blue>void         </FONT>ActivateDisp();
    <FONT color=blue>void         </FONT>CloseDisp   ();</B>
...
};
<HR></TT></PRE>

<P>
Я не стал приводить текст соответствующих методов, так как это заняло бы
слишком много места. Их можно посмотреть в исходных текстах программы.
Необходимо будет также внести соответствующие изменения в классы
<B>CXOfficeDoc</B> и <B>CXOfficeView</B>.

<PRE><TT><HR><FONT color=green>// CXOfficeView.cpp</FONT>

<FONT color=blue>void </FONT>CXOfficeView::OnInitialUpdate()
{
...
    m_pSelection = GetDocument()-&gt;m_ctrl;
<B>    m_pSelection-&gt;AttachDisp();</B>

<FONT color=green>    //Active documents should always be activated</FONT>
...
<B>    m_pSelection-&gt;ActivateDisp();</B>
}
<HR>
<FONT color=green>// CXOfficeDoc.cpp</FONT>

<FONT color=blue>void </FONT>CXOfficeDoc::OnCloseDocument()
{
<B>    <FONT color=blue>if </FONT>(m_ctrl)</B>
<B>        m_ctrl-&gt;CloseDisp();</B>
    COleDocument::OnCloseDocument();
}
<HR></TT></PRE>

<P><B>10. </B>
Теперь пришло время наделить разумом наш сервер автоматизации.
Для этого определим свойства <B>ActiveDocument</B> и <B>IsActiveDocument</B>
для интерфейса <B>IApplication</B>, а также свойства <B>PStr</B>,
<B>PDouble</B> и <B>PLong</B> для интерфейса <B>IDocument</B>.

<PRE><TT><FONT face="Times New Roman" size=3>Это просто сделать с помощью ATL Wizard'а.
Workspace – Class View – IApplication – Правый мышь – Add Property
Workspace – Class View – IDocument – Правый мышь – Add Property
</FONT></TT></PRE>
<P>Реализацию методов можно посмотреть в исходных текстах.

<P><B>11. </B>
Файлы XOffice.doc и XOffice.xls являются примеры документов Word и Excel.
В Word документе инициализация полей происходит в событии Document_New,
которое явно вызывается из программы. Значение полей
присваивается именованным закладкам. В Excel документе инициализаци ячеек
производится в событии Workbook_Activate. Это не совсем удобно,
но я перепробовал множество вариантов и остановился на этом, как на наиболее
устойчиво работающем. Как я уже говорил, непосредственный вызов макроса из
VBA оставляет Excel в памяти после завершения работы программы.

<P align=right><A href="http://it.nm.ru/">Игорь Л. Ткачёв</A>
<BR><A href="mailto:it@hotmail.ru?Subject=XOffice">it@hotmail.ru</A>
    <h3>Downloads</h3>
    <a href="XOffice_demo.zip"><p>Скачать demo project - 36 Kb</a><br>
    <a href="XOffice_src.zip">Скачать исходник - 71 Kb</a> <br>
    <br>
    </td>
  </tr>
</table>
</center></div>


<hr>
<div align="center"><center>

<table border="0" cellpadding="0" cellspacing="3" width="468">
  <tr>
    <td width="154"><!-- LBE_LITE --> <script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://lite.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://lite.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE_LITE ismap></a><br>");
// -->
</script> <noscript> <br>
</noscript><!-- LBE_LITE --></td>
  </tr>
</table>
</center></div>
</body>
</html>
