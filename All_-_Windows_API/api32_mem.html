<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<style type="text/css">
A.black:link {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:visited {COLOR: #000000; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
A.black:hover {COLOR: #FFFFFF; TEXT-DECORATION: none;FONT-FAMILY: Arial,Verdana,Tahoma,sans-serif; FONT-SIZE: 9pt}
.b {text-decoration: none; color:#FF0000;} 
.b:hover {color:#7785FF;}
.c {text-decoration: none; color:#000000;} 
.c:hover {color:#FFFFFF;}
 pre {color: blue;}
TD.colon {COLOR: #000000; FONT-FAMILY: "MS Sans Serif", sans-serif; FONT-SIZE: 9pt}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta content="программирование на Visual Basic, документация, документы, delphi, pascal, cpp, hardware, web, веб-мастер, советы, описания, доки, manual, Java, C, C++, обучение, исходники, odbc, jdbc, programm, protocols, протоколы, общение, форумapplet, java, design, апплет, дизайн, ява, Free, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources, counters, Trackers, Guestbooks, Access Logs, Banners, Graphics, Banner ads, Fonts, Form Mailer, form mailers, graphics, icons, games, freeware, shareware, forms, guestbooks, Java, Javascript, contests, puzzles, fonts, font resources, E-mail programs, reminder services, product samples, samples, Email services, E-mail services, advertising, graphics, free banner ads, free World Wide Web resources" name="keywords">
<meta NAME="RESOURCE-TYPE"
CONTENT="pop hypertext sources hypermedia server scripting shtml phtml html developer code base tools open source web site browser free software webmaster cgi dhtml dynamic content netscape explorer shareware download website construction free tutorial news design maintenance page hit cvs mailing list projects httpd mod_perl mod www htdig xml perl scripts script server-side-include apache database MySQL mysql msql postres postresql module linux online cpp Visual Basic JavaScript delphi wap job informer java opengl directx">
<title>Информационный сервер для программистов - исходники со всего света.</title>
</head>

<body topmargin="0" leftmargin="0" marginwidth="0" marginheigth="0" bgcolor=white>



<!-- Spidersoft WebZIP Banner Ad Insert -->
<!-- For removal instructions see:  http://www.spidersoft.com/webzip/help/noads.asp  -->

<SCRIPT FOR=window EVENT=onload LANGUAGE="JScript">
  initAd();
</SCRIPT>

<script language="JScript">
<!--

function initAd() {
  document.all.AdLayer.style.posTop = -200;
  document.all.AdLayer.style.visibility = 'visible'
  MoveLayer('AdLayer');
}

function MoveLayer(layerName) {
  var x = 10;
  var y = 10;
  var diff = (document.body.scrollTop + y - document.all.AdLayer.style.posTop)*.40;
  var y = document.body.scrollTop + y - diff;
  eval("document.all." + layerName + ".style.posTop =  y");
  eval("document.all." + layerName + ".style.posLeft = x");
  setTimeout("MoveLayer('AdLayer');", 60);
}

if (navigator.onLine){
  document.write("<div bgcolor=#000000 style='height=70px;'></div>");
  document.write("<div id=AdLayer style='position:absolute; width:100%; height:80px; z-index:20; visibility:hidden;'>");
  document.write("<IFRAME SRC='http://www.spidersoft.com/ads/bwz468_60.asp' width=100% height=60 marginwidth=0 marginheight=0 hspace=0 vspace=0 frameborder=0 scrolling=no></IFRAME>");
  document.write("</div>");
}
 //-->
</script>

<!-- /Spidersoft WebZIP Banner Ad Insert -->




<form action="/cgi-bin/sources/search/search.pl" method="get" align="left">
  <input type="hidden" name="stpos" value="0"><table border="0" cellpadding="0"
  cellspacing="0" width="750">
    <tr>
      <td valign="top" rowspan="2"><table border="0" cellpadding="0" cellspacing="0" width="287">
        <tr>
          <td colspan="2" bgcolor="#A5E4A7" valign="middle" align="center"><b>WWW.ИСХОДНИКИ.РУ</b></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">cpp.sources.ru</font></b></td>
        </tr>
        <tr>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">java.sources.ru</font></b></td>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>web.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>soft.sources.ru</b></font></td>
        </tr>
        <tr>
          <td bgcolor="#C0C0C0" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>jdbc.sources.ru</b></font></td>
          <td bgcolor="#A5E4A7" valign="middle" align="center"><font face="Tahoma"
          style="font-size: 8pt" size="-1"><b>asp.sources.ru</b></font></td>
          <td bgcolor="#000080" valign="middle" align="center"><b><font face="Tahoma"
          style="font-size: 8pt" size="-1" color="#FFFFFF">api.sources.ru</font></b></td>
        </tr>
      </table>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr>
          <td><font style="font-size: 8pt" size="2" face="Tahoma">&nbsp; Поиск по
          программированию :<br>
          </font>&nbsp; <input type="text" size="13" name="query"> <input type="submit"
          value="Поиск"><font size="1"><input
          TYPE="Radio" NAME="stype" VALUE="AND" checked>&quot;AND&quot; <input TYPE="Radio"
          NAME="stype" VALUE="OR">&quot;OR&quot;</font>


<!--TopList COUNTER--><a target=_top
href="http://top.list.ru/jump?from=89876"><script language="JavaScript"><!--
d=document;a='';a+=';r='+escape(d.referrer)
js=10//--></script><script language="JavaScript1.1"><!--
a+=';j='+navigator.javaEnabled()
js=11//--></script><script language="JavaScript1.2"><!--
s=screen;a+=';s='+s.width+'*'+s.height
a+=';d='+(s.colorDepth?s.colorDepth:s.pixelDepth)
js=12//--></script><script language="JavaScript1.3"><!--
js=13//--></script><script language="JavaScript"><!--
d.write('<img src="http://top.list.ru/counter'+
'?id=89876;t=57;js='+js+a+';rand='+Math.random()+
'" alt="TopList" '+ 'border=0 height=1 width=1>')
if(js>11)d.write('<'+'!-- ')//--></script><noscript><img
src="http://top.list.ru/counter?js=na;id=89876;t=57"
border=0 height=1 width=1
alt="TopList"></noscript><script language="JavaScript"><!--
if(js>11)d.write('--'+'>')//--></script></a><!--TopList COUNTER-->


<a href="http://counter.rambler.ru/top100/"><img src="http://counter.rambler.ru/top100.cnt?163871" alt="Rambler's Top100" width=1 height=1 border=0></a>

<!-- SpyLOG f:0211 --> 
<script language="javascript"> 
u="u1624.10.spylog.com";d=document;nv=navigator;na=nv.appName;p=1; 
bv=Math.round(parseFloat(nv.appVersion)*100); 
n=(na.substring(0,2)=="Mi")?0:1;rn=Math.random();z="p="+p+"&rn="+rn;y=""; 
y+="<a href='http://"+u+"/cnt?f=3&p="+p+"&rn="+rn+"' target=_blank>"; 
y+="<img src='http://"+u+"/cnt?"+z+ "&r="+escape(d.referrer)+"&pg="+escape(window.location.href)+"' border=0 width=1 height=1 alt='SpyLOG'>"; 
y+="</a>"; d.write(y);if(!n) { d.write("<"+"!--"); }//--></script><noscript> 
<a href="http://u1624.10.spylog.com/cnt?f=3&p=1" target=_blank> 
<img src="http://u1624.10.spylog.com/cnt?p=1" alt='SpyLOG' border='0' width=1 height=1 > 
</a></noscript><script language="javascript1.2"><!-- 
if(!n) { d.write("--"+">"); }//--></script> 
<!-- SpyLOG -->


</td>
        </tr>
      </table>
      </td>
      <td align="center"><font style="font-size: 15pt" color="#4904B1" size="4"
      face="Times New Roman">Информационный сервер</font></td>
    </tr>
    <tr>
      <td>


<!-- LBE -->
<script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://www.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://www.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE ismap></a><br>");
// -->
</script>
<noscript>
                                                                                                                                                                <br>
</noscript>
<!-- LBE -->



      </td>
    </tr>
    <tr>
      <td colspan="2"><table border="0" cellpadding="0" cellspacing="1" width="100%">
        <tr>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a
          href="../www.sources.html"><font color="#000000" size="2">На главную</font></a></td>
          <td align="center" width="20%" bgcolor="#E0E0C6"><a
          href="../subscribe.html"><font color="#000000" size="2">Подписаться на новости</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../cgi-bin/sources/Ultimate.pl"><font color="#000000" size="2">Форум</font></a></td>
          <td align="center" width="11%" bgcolor="#E0E0C6"><a href="../books.html"><font color="#000000" size="2">Книги</font></a></td>
          <td align="center" width="7%" bgcolor="#E0E0C6"><a href="http://chat.vidcenter.ru:82/"><font color="#000000" size="2">Чат</font></a></td>
          <td align="center" width="13%" bgcolor="#E0E0C6"><a href="http://www.countries.ru/"><font color="#000000" size="2">Страны мира</font></a></td>
          <td align="center" width="29%" bgcolor="#E0E0C6"><b>6</b> пользователей на сервере.
</td>
        </tr>
      </table>
      </td>
    </tr>
  </table>
</form>


<h3 align="center">Память в Win32.</h3>

<h3 align="center">Директива #pragma data_seg().</h3>

<p align="center"><a href="mailto:ilya@mayor.kht.ru">(c) И.В. Радинский,
06.10.1999 г</a>.</p>

<hr>

<p><font face="Times New Roman" size="2">&nbsp;</p>

<p></font><font size="3">Как-то раз, передо мной встала
проблема - у меня была куча EXE- и DLL-файлов,
входящих в одну большую систему. Как водится в
больших системах, у нее были одни глобальные
настройки и объекты, которые использовали те или
иные модули одновременно. Настройки - это не
проблема ведь можно просто хранить их в одном
файле, который читают все модули. Проблема в
объектах - я захотел создать группу разделяемых
объектов по работе с БД, и чтобы все модули видели
их, ну и заодно можно было бы хранить и общие
настройки. Я хотел это реализовать в одной DLL,
которую загружали бы модули, и получали бы, таким
образом, доступ к этим общим данным.</p>

<p>Проблема нетривиальная - ведь в Win32 каждый
процесс имеет свое собственное адресное
пространство в 4 Гб, и это все, что он &quot;видит&quot;.
Если процесс загружает DLL, то ее код проецируется
в его адресное пространство и она (DLL) при этом
теряет почти всю свою индивидуальность: для
потоков код и данные DLL - просто дополнительный
код и данные, оказавшиеся в адресном
пространстве процесса. Когда поток вызывает из DLL
какую-то функцию, та считывает свои параметры из
стека потока и размещает в этом стеке
собственные локальные переменные. Кроме того,
любые созданные кодом DLL объекты принадлежат
вызывающему потоку или процессу - DLL в Win32 ничем не
владеет.</p>

<p>Но. Есть одно &quot;но&quot;. Переменные в EXE- или
DLL-файлах можно поместить в особые раделы,
которые можно разделить для всех процессов. </p>

<p>Немного о разделах. Начнем с того, что любой
образ EXE- или DLL-файла состоит из группы разделов
(sections). Вот названия наиболее часто встречающихся
разделов:</font></p>
<div align="center"><center>

<table border="1" cellPadding="7" cellSpacing="1" width="491">
<TBODY>
  <tr>
    <td vAlign="top" width="21%"><font face="Times New Roman" size="2"><i><b>Имя
    раздела</b></i></font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2"><i><b>Описание</b></i></font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.text</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Код
    приложения или </font><font size="2">DLL.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.bss</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Неинициализированные
    данные.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.rdata</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Неизменяемые
    данные периода выполнения.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.rsrc</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Ресурсы.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.edata</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Таблица
    экспортируемых имен.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.data</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Инициализированные
    данные.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.xdata</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Таблица для
    обработки исключений.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.idata</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Таблица
    импортируемых имен.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.CRT</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Неизменяемые
    данные стандартной библиотеки </font><font size="2">C.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.reloc</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Настроечная
    информация - таблица переадресации (</font><font size="2">fixup
    table).</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.debug</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Отладочная
    информация.</font></td>
  </tr>
  <tr>
    <td vAlign="top" width="21%"><font size="2">.tls</font></td>
    <td vAlign="top" width="79%"><font face="Times New Roman" size="2">Локальная
    память потока.</font></td>
  </tr>
</TBODY>
</table>
</center></div>

<p><font face="Times New Roman" size="2">&nbsp;</p>

<p></font><font size="3">Попробуйте посмотреть любой EXE- или
DLL-файл - и вы наверняка найдете несколько
разделов из этой таблицы.</p>

<p>Так вот, например, этот код:</p>

<p></font><font color="#0000ff" face="Courier New" size="2">#pragma data_seg</font><font
color="#000000" face="Courier New" size="2">(</font><font color="#000080"
face="Courier New" size="2">&quot;MySection&quot;</font><font color="#000000"
face="Courier New" size="2">)<br>
TCHAR szName[</font><font color="#ff0000" face="Courier New" size="2">100</font><font
color="#000000" face="Courier New" size="2">] = {</font><font color="#ff0000"
face="Courier New" size="2">0</font><font color="#000000" face="Courier New" size="2">};<br>
LONG lModuleUsage;<br>
</font><font color="#0000ff" face="Courier New" size="2">#pragma data_seg</font><font
color="#000000" face="Courier New" size="2">()<br>
</font><font color="#0000ff" face="Courier New" size="2">#pragma comment</font><font
color="#000000" face="Courier New" size="2">(linker,</font><font color="#000080"
face="Courier New" size="2">&quot;/SECTION:MySection, RWS&quot;</font><font
color="#000000" face="Courier New" size="2">) </font><font size="3"><font
face="Times New Roman"></p>

<p></font>заставит компилятор создать раздел MySection и
поместить в него все <u>ИНИЦИАЛИЗИРОВАННЫЕ</u>
переменные, встретившиеся между #pragma
data_seg(&quot;MySection&quot;) и #pragama data_seg(). Директива #pragma
comment(linker, &quot;/SECTION:MySection, RWS&quot;) говорит
компановщику включить строку сделать раздел
MySection с аттрибутами READ, WRITE и SHARED. Угадайте с трех
раз, какие переменные попадут в эту раздел. Вот
они - грабли !!! Только szName и попадет ! А lModuleUsage
попадает в секцию .bss (неинициализированные
данные) - т.е. каждый поток будет иметь свою
собственную lModuleUsage ! Отсюда сразу выходит, что
код типа </p>

<p></font><font color="#0000ff" face="Courier New" size="2">#pragma data_seg</font><font
color="#000000" face="Courier New" size="2">(</font><font color="#000080"
face="Courier New" size="2">&quot;MySection&quot;</font><font color="#000000"
face="Courier New" size="2">)<br>
CSesssion g_Session;<br>
</font><font color="#0000ff" face="Courier New" size="2">#pragma data_seg</font><font
color="#000000" face="Courier New" size="2">()<br>
</font><font color="#0000ff" face="Courier New" size="2">#pragma comment</font><font
color="#000000" face="Courier New" size="2">(linker, </font><font color="#000080"
face="Courier New" size="2">&quot;/SECTION:MySection, RWS&quot;</font><font
color="#000000" face="Courier New" size="2">)</font></p>

<p><font size="3">обречен - переменная g_Session будет в
разделе .bss, а никак не в MySection.</p>

<p>Если подумать, то это справедливо - ведь каждый
процесс вызывает конструктор объекта. А где
исполняется конструктор - правильно, в адресном
пространстве процесса. И все побочные данные
объекта где будут? В адресном пространстве этого
самого процесс а, что для других процессов уже
никак не подходит.</p>

<p>А от такой схемы пришлось отказаться. Во-первых
таким образом нарушается зашита уровня B (B-level
security). Во-вторых ошибки в приложении с общими
переменными могу повлиять на другие приложения,
т.е. одна программа может &quot;завалить&quot; всю
систему. </font></p>



<hr>
<div align="center"><center>

<table border="0" cellpadding="0" cellspacing="3" width="468">
  <tr>
    <td width="154"><!-- LBE_LITE --> <script>
// <!--
rand = Math.round((Math.random() * (10000 - 1)));
document.write("<a href=http://lite.lbe.ru/cgi-bin/href/castle?" + rand + " target=_blank><img src=http://lite.lbe.ru/cgi-bin/banner/castle?" + rand + " width=468 height=60 border=0 alt=LBE_LITE ismap></a><br>");
// -->
</script> <noscript> <br>
</noscript><!-- LBE_LITE --></td>
  </tr>
</table>
</center></div>
</body>
</html>
